@import './tokens.css';

@layer base, layout, components, utilities;

@layer base {
  :focus-visible {
    outline: 2px solid var(--gold);
    outline-offset: 2px;
  }

  html,
  body {
    background: #0a0c0e !important;
  }

  #page-container,
  #et-boc,
  body > *:not(#eft-bg-grid):not(#eft-bg-noise) {
    position: relative;
    z-index: 1;
    isolation: isolate;
  }
}

@layer layout {
  #eft-bg-grid,
  #eft-bg-noise {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }

  /* Subtle grid + mild warble */
  #eft-bg-grid {
    --gx: 0px;
    --gy: 0px;
    background:
      radial-gradient(140% 100% at 50% -10%, rgba(0, 0, 0, 0.35), transparent 60%),
      radial-gradient(120% 80% at 85% -10%, rgba(214, 185, 134, 0.14), transparent 60%),
      repeating-linear-gradient(90deg, rgba(214, 185, 134, 0.06) 0 1px, transparent 1px 80px),
      repeating-linear-gradient(0deg, rgba(214, 185, 134, 0.06) 0 1px, transparent 1px 80px),
      linear-gradient(0deg, rgba(255, 255, 255, 0.035) 0 1px, transparent 1px 2px);
    background-position: 0 0, 0 0, var(--gx) 0, 0 var(--gy), 0 0;
    animation: gridWobble 7s ease-in-out infinite, scanDrift 18s linear infinite;
  }

  @keyframes gridWobble {
    0% { --gx: 0; --gy: 0; }
    35% { --gx: 1.2px; --gy: 0.8px; }
    55% { --gx: 1.6px; --gy: 1.2px; }
    85% { --gx: 0.9px; --gy: 0.5px; }
    100% { --gx: 0; --gy: 0; }
  }

  @keyframes scanDrift {
    0% { background-position: 0 0, 0 0, var(--gx) 0, 0 var(--gy), 0 0; }
    100% { background-position: 0 3px, 0 0, var(--gx) 0, 0 var(--gy), 0 0; }
  }

  #eft-wrap {
    width: var(--mainW);
    margin: 0 auto;
    padding: 28px 0;
  }

  /* Desktop sidebar (left), symmetric spacing enforced by JS */
  #eft-side {
    position: fixed;
    left: var(--gap);
    top: 0;
    z-index: 5;
  }

  #eft-side .bubble {
    background: linear-gradient(#101214, #0b0d0f);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 12px;
  }

  #eft-side .title {
    color: #66707a;
    font: 700 11px "Courier New", Courier, ui-monospace;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    padding: 4px 8px 8px;
  }

  #eft-side .snav {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #eft-side .slink {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 999px;
    background: var(--soft);
    color: var(--text);
    text-decoration: none;
    font: 700 12px "Courier New", Courier, ui-monospace;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  #eft-side .slink:hover {
    border-color: var(--gold-2);
    color: var(--gold);
    box-shadow: inset 0 0 0 1px rgba(214, 185, 134, 0.15);
  }

  /* Legal text block under menu */
  .legal-text {
    margin: 10px 8px 4px;
    color: var(--muted);
    font: 600 10.5px "Courier New", Courier, ui-monospace;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    opacity: 0.9;
  }

  .legal-text a {
    color: inherit;
    text-decoration: none;
    border-bottom: 1px dotted transparent;
  }

  .legal-text a:hover {
    color: var(--gold);
    border-bottom-color: var(--gold-2);
  }

  /* Mobile burger */
  #eft-burger {
    display: none;
    position: fixed;
    left: var(--gap);
    top: 12px;
    z-index: 7;
    width: 42px;
    height: 42px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: var(--soft);
    color: var(--text);
    font-size: 20px;
    line-height: 40px;
    text-align: center;
  }

  #eft-burger:focus-visible { outline: 2px solid var(--gold); }

  #eft-offcanvas {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 8;
    background: rgba(0, 0, 0, 0.5);
  }

  #eft-offcanvas[aria-hidden="false"] { display: block; }

  #eft-offcanvas .panel {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: min(84vw, 360px);
    background: #0c0f11;
    border-right: 1px solid var(--line);
    padding: 16px;
    box-shadow: var(--shadow);
    overflow: auto;
  }

  #eft-offcanvas .panel .bubble {
    background: none;
    border: none;
    box-shadow: none;
    padding: 0;
  }

  #eft-offcanvas .close {
    position: absolute;
    right: 10px;
    top: 10px;
    border: 1px solid var(--line);
    background: var(--soft);
    color: var(--text);
    border-radius: 8px;
    padding: 6px 10px;
  }

  @media (max-width: 1400px) {
    #eft-side { display: none; }
    #eft-burger { display: block; }
  }
}

@layer components {
  #eft-cw,
  #eft-cw * {
    box-sizing: border-box;
  }

  #eft-cw {
    color: var(--text);
    font: 14px/1.5 "Courier New", Courier, ui-monospace, Menlo, Consolas, monospace;
    letter-spacing: 0.02em;
  }

  .hero {
    background: linear-gradient(#0f1113, #0b0d0f);
    border: 1px solid var(--line);
    border-radius: var(--r);
    padding: 22px 26px;
    margin: 0 0 16px;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .hero h1 {
    margin: 0 0 6px;
    color: var(--gold);
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    text-shadow: 0 0 6px rgba(214, 185, 134, 0.12);
  }

  .hero .sub {
    color: var(--gold-2);
    letter-spacing: 0.22em;
    font-size: 11px;
    text-transform: uppercase;
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin: 18px 0 16px;
  }

  .stat {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--rsm);
    padding: 12px 14px;
    text-align: center;
  }

  .stat .num {
    color: var(--gold);
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 0.04em;
  }

  .stat .lbl {
    color: var(--muted);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    margin-top: 2px;
  }

  @media (max-width: 560px) {
    .stats { grid-template-columns: repeat(2, 1fr); }
  }

  .bar {
    position: sticky;
    top: 12px;
    z-index: 6;
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--rsm);
    padding: 10px;
    margin: 0 0 18px;
    flex-wrap: nowrap;
    overflow-x: auto;
    backdrop-filter: blur(2px);
  }

  .bar label { color: var(--muted); font-size: 12px; white-space: nowrap; }

  .bar .bar-label {
    color: var(--muted);
    font-size: 12px;
    white-space: nowrap;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    font-weight: 700;
  }

  select,
  input[type="checkbox"] { accent-color: var(--gold-2); }

  select {
    background: var(--soft);
    color: var(--text);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 8px 10px;
    outline: none;
    min-width: 180px;
  }

  .btn {
    background: var(--soft);
    color: var(--text);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 13px;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn:hover {
    border-color: var(--gold-2);
    color: var(--gold);
  }

  .search {
    flex: 0 1 220px;
    display: flex;
    gap: 8px;
    align-items: center;
    min-width: 160px;
  }

  .search input {
    width: 100%;
    background: #0c0f11;
    color: var(--text);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 10px 12px;
    outline: none;
  }

  .search .clear { white-space: nowrap; }

  @media (max-width: 980px) {
    .bar { flex-wrap: wrap; overflow-x: visible; }
    .search { flex: 1 1 100%; }
    .btn,
    select { width: 100%; }
  }

  .columns { display: flex; gap: 16px; align-items: flex-start; }
  .col { flex: 1 1 0; min-width: 0; display: flex; flex-direction: column; gap: 16px; }
  @media (max-width: 980px) { .columns { display: block; } .col { width: 100%; } }

  .section {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: var(--r);
    display: flex;
    flex-direction: column;
    min-width: 0;
    height: clamp(420px, 62vh, 640px);
  }

  @media (max-width: 980px) { .section { height: clamp(380px, 58vh, 560px); } }
  @media (max-width: 560px) { .section { height: clamp(340px, 56vh, 520px); } }

  .section.is-collapsed { height: auto; }

  .sec-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid var(--line);
  }

  .sec-left { display: flex; align-items: center; gap: 10px; }

  .toggle {
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
    background: var(--soft);
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--gold);
    font-weight: 800;
    cursor: pointer;
  }

  .toggle:hover {
    border-color: var(--gold-2);
    box-shadow: inset 0 0 0 1px rgba(214, 185, 134, 0.15);
  }

  .sec-title {
    color: var(--gold);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    font-size: 13px;
    font-weight: 700;
  }

  .sec-count { color: var(--muted); font-size: 12px; }

  .task-wrap { padding: 10px 12px; overflow: auto; flex: 1; }
  .section.is-collapsed .task-wrap { display: none; }
  .section.is-collapsed .sec-head { border-bottom: none; }

  .task {
    border: 1px solid var(--line);
    background: var(--soft);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
  }

  .task-row { display: flex; gap: 10px; align-items: flex-start; min-width: 0; }
  .task input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; }
  .t-name { color: var(--text); font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .t-obj { color: var(--muted); font-size: 12px; margin-top: 3px; overflow-wrap: anywhere; }
  .task.done .t-name { text-decoration: line-through; color: #6b7280; }
  .task.done { opacity: 0.85; }

  .t-kappa {
    margin-left: auto;
    font-size: 11px;
    color: var(--gold);
    border: 1px solid var(--gold-2);
    padding: 2px 8px;
    border-radius: 8px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    background: rgba(214, 185, 134, 0.08);
  }

  .badge-defunct {
    margin-left: 8px;
    font-size: 11px;
    color: #fff;
    border: 1px solid var(--danger-2);
    padding: 2px 8px;
    border-radius: 8px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    background: var(--danger);
    position: relative;
    cursor: help;
  }

  .badge-defunct::after {
    content: attr(data-tip);
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(100% + 8px);
    background: #0c0f11;
    color: var(--text);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 8px 10px;
    white-space: nowrap;
    font-size: 12px;
    opacity: 0;
    pointer-events: none;
    box-shadow: var(--shadow);
    transition: opacity 0.15s;
  }

  .badge-defunct::before {
    content: "";
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 100%;
    border: 6px solid transparent;
    border-top-color: #0c0f11;
    margin-bottom: 2px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .badge-defunct:hover::after,
  .badge-defunct:hover::before { opacity: 1; }

  .task.defunct { border-color: var(--danger-2); background: #151012; }
  .task.defunct .t-name { color: #e7bcbc; text-decoration: line-through; text-decoration-thickness: 1px; }

  .t-tools { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
  .mini-btn { background: var(--soft); color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 10px; font-size: 13px; cursor: pointer; text-decoration: none; }
  .mini-btn:hover { border-color: var(--gold-2); color: var(--gold); }

  .details { margin-top: 8px; padding: 8px; border: 1px dashed var(--line); border-radius: 8px; background: #0c0f11; }

  .task-wrap::-webkit-scrollbar { width: 10px; }
  .task-wrap::-webkit-scrollbar-thumb { background: #1e2327; border: 2px solid #0f1214; border-radius: 8px; }

  #eft-confetti { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }

  .skeleton { position: relative; overflow: hidden; background: #111416; border: 1px solid #1f252a; border-radius: 10px; height: 56px; }
  .skeleton::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.06), transparent); transform: translateX(-100%); animation: sheen 1.2s infinite; }
  @keyframes sheen { 100% { transform: translateX(100%); } }

  .err { background: #2a1111; border: 1px solid #6b1b1b; color: #f5c7c7; border-radius: 10px; padding: 10px 12px; margin: 10px 0; }

  #eft-toast {
    position: fixed;
    left: 50%;
    bottom: 24px;
    transform: translateX(-50%);
    background: #0e1012;
    border: 1px solid var(--line);
    color: var(--text);
    border-radius: 10px;
    padding: 10px 12px;
    display: none;
    gap: 10px;
    align-items: center;
    z-index: 9999;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
  }

  #eft-toast.show { display: flex; }
  .toast-actions .btn { padding: 8px 10px; }
  mark.eft-hit { background: rgba(214, 185, 134, 0.25); color: inherit; padding: 0 2px; border-radius: 2px; }
}

@layer utilities {
  @media (prefers-reduced-motion: reduce) {
    #eft-bg-grid { animation: none; }
    #eft-bg-noise { display: none; }
  }
}
